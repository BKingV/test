import streamlit as st
import pandas as pd
from docx import Document
import re

st.title("üìÑ –û–Ω–ª–∞–π–Ω-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ Word-—Ñ–∞–π–ª–∞")

uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ Word-—Ñ–∞–π–ª —Å —Ç–µ—Å—Ç–∞–º–∏", type=["docx"])

def extract_questions_from_docx(doc):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –∏–∑ Word-—Ñ–∞–π–ª–∞."""
    questions = []
    current_question = None
    answers = []

    question_pattern = re.compile(r"^\d+[\.\)]|\b[‚Ññ]\s*\d+")  # –ò—â–µ–º –Ω–æ–º–µ—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ (1., 2), (‚Ññ 1, ‚Ññ2)

    for para in doc.paragraphs:
        text = para.text.strip()
        
        if question_pattern.match(text) or text.endswith("?"):
            # –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –Ω–∞–π–¥–µ–Ω
            if current_question:
                questions.append({"question": current_question, "answers": answers})
            current_question = text
            answers = []
        elif text and current_question:
            answers.append(text)
    
    if current_question and answers:
        questions.append({"question": current_question, "answers": answers})

    return questions

if uploaded_file:
    doc = Document(uploaded_file)
    questions = extract_questions_from_docx(doc)

    if not questions:
        st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –≤–æ–ø—Ä–æ—Å—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞.")
    else:
        st.session_state["questions"] = questions
        st.success(f"–ù–∞–π–¥–µ–Ω–æ {len(questions)} –≤–æ–ø—Ä–æ—Å–æ–≤. –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Ç–µ—Å—Ç!")
        if st.button("–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç"):
            st.session_state["current_question"] = 0
            st.session_state["score"] = 0
            st.rerun()

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
if "questions" in st.session_state and "current_question" in st.session_state:
    q_idx = st.session_state["current_question"]
    question_data = st.session_state["questions"][q_idx]

    st.subheader(question_data["question"])
    selected_answer = st.radio("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç:", question_data["answers"])

    if st.button("–û—Ç–≤–µ—Ç–∏—Ç—å"):
        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
        if q_idx + 1 < len(st.session_state["questions"]):
            st.session_state["current_question"] += 1
            st.rerun()
        else:
            st.success("–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")
            st.write(f"–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ {len(st.session_state['questions'])} –≤–æ–ø—Ä–æ—Å–æ–≤.")
